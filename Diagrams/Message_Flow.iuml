@startuml Message_Flow
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Sequence.puml

actor Client
participant "API" as API
participant "NotificationHub" as Hub
participant "MessageService" as Service
database "Database" as DB

== Message Sending ==
Client -> API: Send Message
API -> Service: Process Message
Service -> DB: Store Message
Service -> Hub: Attempt Delivery
Hub -> Client: Deliver Message
Client -> API: Acknowledge Message
API -> Service: Process Acknowledgment
Service -> DB: Update Message Status

== Message Retry ==
box "Background Process" #LightBlue
    participant "RetryService" as Retry
end box

Retry -> DB: Find Unacknowledged Messages
DB -> Retry: Return Messages
loop for each unacknowledged message
    Retry -> Hub: Attempt Redelivery
    Hub -> Client: Deliver Message
    alt success
        Client -> API: Acknowledge Message
        API -> Service: Process Acknowledgment
        Service -> DB: Update Message Status
    else timeout
        Retry -> DB: Update Retry Count
    end
end

@enduml